<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quiz Maker ‚Äî¬î full build (fixed)</title>
<style>
  :root{--bg:#f4faff;--card:#fff;--ink:#163046;--muted:#5e7180;--line:#d6e2ea;--accent:#2e7d32}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  main{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{display:flex;align-items:center;gap:10px;margin:8px 0 14px}
  .tabs{display:flex;gap:10px;margin:8px 0 18px}
  .tabs button{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 16px;cursor:pointer}
  .tab-content{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  label{display:block;margin:10px 0 6px}
  input[type=text], input[type=number], textarea, select{width:100%;box-sizing:border-box;border:1px solid #c8d7e1;border-radius:10px;padding:10px 12px;font-size:16px}
  textarea{min-height:80px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .btn{padding:10px 14px;border:1px solid #b8c9d6;border-radius:12px;background:#fff;cursor:pointer}
  .btn-primary{background:var(--accent);border:none;color:#fff}
  .btn-ghost{background:transparent;border:1px dashed #b9cadd}
  .muted{color:var(--muted)}
  .question-item{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 100px 10px 10px;margin:8px 0;cursor:grab;position:relative;display:flex;align-items:center}
  .question-item.dragging{opacity:.7}
  .q-title{flex:1}
  .tiny-thumb{width:24px;height:24px;object-fit:cover;margin-left:6px;border-radius:4px;vertical-align:middle}
  .media-icon{margin-left:6px;font-size:18px;vertical-align:middle}
  .question-actions{position:absolute;right:8px;top:8px;display:flex;gap:6px}
  .q-content{display:flex;align-items:center;gap:6px}
  .banner{padding:10px 12px;border-radius:10px;margin-top:12px}
  .banner.ok{background:#e8f5e9;color:#1b5e20;border:1px solid #b7e1c0}
  .banner.err{background:#ffebee;color:#b71c1c;border:1px solid #f3b0b5}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .sort-list{list-style:none;padding:0;margin:0}
  .sort-list li{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#fafafa;position:relative}
  .opt{display:block;width:100%;text-align:left;margin:6px 0}
  .thumb{max-width:100%;max-height:160px;border-radius:8px;display:block}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .chip[aria-pressed="true"]{background:#e8f5ff;border-color:#b3defc}
  .dragging-el{opacity:.7}
  #catsPanel{overflow:hidden;max-height:0;transition:max-height .3s ease;margin-top:8px}
  body[data-theme='child'] input,body[data-theme='child'] select,body[data-theme='child'] .btn{font-size:20px;padding:14px;border-radius:18px}
</style>
</head>
<body>
<main>
  <h1>üìö¬ö Quiz Maker</h1>
  <div class="tabs">
    <button id="tab-editor"></button>
    <button id="tab-player"></button>
    <button id="tab-settings"></button>
  </div>

  <section id="editor" class="tab-content">
    <h2 id="editorTitle">Edit Questions</h2>
    <button id="newQuestion" class="btn">‚ûï New question</button>

    <div id="editorForm" style="display:none">
      <label id="questionLabel">Question</label>
      <input id="questionText" type="text" placeholder="Type your question" />
      <div class="row" id="qMediaRow">
        <input type="file" id="qImg" accept="image/*" style="display:none"/>
        <input type="file" id="qAud" accept="audio/*" style="display:none"/>
        <button id="qImgPick" class="chip" type="button">üñºÔ∏è Image</button>
        <img id="qImgPrev" class="thumb" style="display:none"/>
        <button id="qImgClear" class="btn" type="button" style="display:none">Clear image</button>
        <button id="qAudPick" class="chip" type="button">üîà Audio</button>
        <span id="qAudMini" style="display:none"></span>
        <button id="qAudClear" class="btn" type="button" style="display:none">Clear audio</button>
        <input type="file" id="qVid" accept="video/*" style="display:none"/>
        <button id="qVidPick" class="chip" type="button">üìπ Video</button>
        <span id="qVidMini" style="display:none"></span>
        <button id="qVidClear" class="btn" type="button" style="display:none">Clear video</button>
      </div>

      <label id="questionTypeLabel">Type</label>
      <select id="questionType">
        <option id="questionTypeSingle" value="single">Single Choice</option>
        <option id="questionTypeMultiple" value="multiple">Multiple Choice</option>
        <option id="questionTypeText" value="text">Enter Answer (text)</option>
        <option id="questionTypeMultitext" value="multitext">Multiple Text Inputs</option>
        <option id="questionTypeMatching" value="matching">Matching (drag right)</option>
        <option id="questionTypeOrder" value="order">Put in the right order</option>
      </select>

      <div id="questionOptionsContainer" style="margin-top:10px"></div>

      <label id="commentLabel">Comment (optional)</label>
      <textarea id="questionComment" placeholder="Shown with feedback when enabled"></textarea>
      <div class="row" id="cMediaRow">
        <input type="file" id="cImg" accept="image/*" style="display:none"/>
        <input type="file" id="cAud" accept="audio/*" style="display:none"/>
        <button id="cImgPick" class="chip" type="button">üñºÔ∏è Image</button>
        <img id="cImgPrev" class="thumb" style="display:none"/>
        <button id="cImgClear" class="btn" type="button" style="display:none">Clear image</button>
        <button id="cAudPick" class="chip" type="button">üîà Audio</button>
        <span id="cAudMini" style="display:none"></span>
        <button id="cAudClear" class="btn" type="button" style="display:none">Clear audio</button>
        <input type="file" id="cVid" accept="video/*" style="display:none"/>
        <button id="cVidPick" class="chip" type="button">üìπ Video</button>
        <span id="cVidMini" style="display:none"></span>
        <button id="cVidClear" class="btn" type="button" style="display:none">Clear video</button>
      </div>

      <label id="categoryLabel">Category / Topic (optional)</label>
      <select id="categorySelect"><option id="catNoneOption" value="">‚Äî none ‚Äî¬î</option></select>
      <div id="categoryNewUI" style="display:none;margin-top:8px"></div>

      <button id="saveQuestion" class="btn btn-primary">üíæ Save question</button>
      <button id="cancelEdit" class="btn" type="button">Cancel</button>
    </div>

    <h3 id="savedQuestionsTitle" style="margin-top:18px">Saved Questions</h3>
    <ul id="questionList" style="list-style:none;padding-left:0"></ul>

    <div class="row" style="margin-top:10px">
      <input type="file" id="importFile" accept="application/json" style="display:none"/>
      <button id="importBtn" class="btn">üìÇ Import JSON</button>
      <button id="exportBtn" class="btn btn-primary">üíæ Export JSON</button>
    </div>
  </section>

  <section id="player" class="tab-content" style="display:none">
    <h2 id="playerTitle">Quiz Time</h2>
    <div id="quizContainer"></div>
    <div id="quizControls"></div>
  </section>

  <section id="settings" class="tab-content" style="display:none">
    <h2 id="settingsTitle">Settings</h2>
    <label id="themeLabel">Theme
      <select id="themeSelect">
        <option id="themeFormal" value="formal">Formal</option>
        <option id="themePlayful" value="playful">Playful</option>
        <option id="themeChild" value="child">Child-friendly</option>
      </select>
    </label>
    <label id="langLabel">Language
      <select id="langSelect">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
      </select>
    </label>
    <h3 id="feedbackHeading">Feedback</h3>
    <label><input type="checkbox" id="feedbackImmediate" checked> <span id="feedbackImmediateLabel">Immediate feedback</span></label>
    <label><input type="checkbox" id="feedbackEnd"> <span id="feedbackEndLabel">Feedback details at end</span></label>
    <label><input type="checkbox" id="showCorrectImmediate" checked> <span id="showCorrectImmediateLabel">Show correct answer when wrong (immediate)</span></label>
    <label><input type="checkbox" id="showComments" checked> <span id="showCommentsLabel">Show comments</span></label>
    <label><input type="checkbox" id="linkifyComments"> <span id="linkifyCommentsLabel">Linkify comment URLs</span></label>
    <h3 id="validationHeading">Validation</h3>
    <label><input type="checkbox" id="autoValidate" checked> <span id="autoValidateLabel">Validate automatically (default)</span></label>
    <h3 id="randomHeading">Random mode</h3>
    <label><input type="checkbox" id="randomMode"> <span id="randomModeLabel">Randomize questions</span></label>
    <label id="randomCountLabel">Number of questions <input type="number" id="randomCount" min="1"></label>
    <h3 id="timeHeading">Time Limit</h3>
    <label id="timeLimitLabel">Time (seconds) <input type="number" id="timeLimitSec" min="0"></label>
    <h3 id="textMatchHeading">Text Matching</h3>
    <label><input type="checkbox" id="caseSensitive"> <span id="caseSensitiveLabel">Case sensitive</span></label>
    <label><input type="checkbox" id="ignorePunct" checked> <span id="ignorePunctLabel">Ignore punctuation</span></label>
    <label><input type="checkbox" id="normalizeAccents" checked> <span id="normalizeAccentsLabel">Normalize accents</span></label>
    <label><input type="checkbox" id="ignoreSpaces" checked> <span id="ignoreSpacesLabel">Collapse spaces</span></label>
    <label><input type="checkbox" id="regexFull" checked> <span id="regexFullLabel">Full regex match (^...$)</span></label>
    <h3 id="mcqHeading">Multiple Choice Scoring</h3>
    <select id="mcqScore">
      <option id="mcq_all" value="all">All-or-nothing</option>
      <option id="mcq_partial" value="partial">Partial credit</option>
      <option id="mcq_partial_penalty" value="partial_penalty">Partial with penalty</option>
    </select>
    <h3 id="speechHeading">Speech</h3>
    <label><input type="checkbox" id="autoTTSQuestions"> <span id="autoTTSQuestionsLabel">Auto-TTS questions</span></label>
    <label><input type="checkbox" id="autoTTSItems"> <span id="autoTTSItemsLabel">Auto-TTS items/options</span></label>

    <h3 id="playModeHeading">Play mode</h3>
    <label><input type="checkbox" id="showCategory"> <span id="showCategoryLabel">Show category during play</span></label>
    <label><input type="checkbox" id="allowSkip"> <span id="allowSkipLabel">Allow skipping questions</span></label>

    <h3><button id="catsToggle" class="btn" type="button">Categories / Topics / Mottos</button></h3>
    <div id="catsPanel"><div id="catsManager"></div></div>

    <button id="saveSettings" class="btn btn-primary">Save settings</button>
    <span id="settingsSaved" style="display:none;margin-left:8px">Saved ‚úì</span>
  </section>
</main>

<script>
// ===== State =====
let questions = JSON.parse(localStorage.getItem('quizData')||'[]');
let meta = Object.assign({ categories: [] }, JSON.parse(localStorage.getItem('quizMeta') || '{}'));
meta.categories = (meta.categories || []).map(c=> ({id:c.id, label:(c.label||c.labels?.en||c.labels?.de||c.id), comment:c.comment||c.hint||''}));
function saveMeta(){ localStorage.setItem('quizMeta', JSON.stringify(meta)); }
let settings = Object.assign({
  feedbackImmediate:true,
  feedbackEnd:false,
  showComments:true,
  linkifyComments:false,
  theme:'formal', lang:'en',
  random:false, randomCount:5, timeLimitSec:0,
  caseSensitive:false, ignorePunct:true, normalizeAccents:true, ignoreSpaces:true, regexFull:true,
  mcqScore:'all', autoTTSQuestions:false, autoTTSItems:false, autoValidate:true,
  showCorrectImmediate:true,
  showCategory:false,
  allowSkip:false
}, JSON.parse(localStorage.getItem('quizSettings')||'{}'));
if('feedback' in settings){
  settings.feedbackImmediate = settings.feedback === 'immediate';
  settings.feedbackEnd = settings.feedback === 'end';
  delete settings.feedback;
}
document.documentElement.lang = settings.lang || 'en';
const STRINGS={
  en:{submit:'Submit',next:'Next',skip:'Skip',correct:'Correct',wrong:'Wrong',time:'Time\'s up!',score:'Score',answers:'Answers',goodguess:'Good guess!'},
  de:{submit:'Senden',next:'Weiter',skip:'√úberspringen',correct:'Richtig',wrong:'Falsch',time:'Zeit abgelaufen!',score:'Punkte',answers:'Antworten',goodguess:'Guter Tipp!'}
};
function t(k){ const lang=settings.lang||'en'; return (STRINGS[lang]&&STRINGS[lang][k])||STRINGS.en[k]||k; }

function applyLang(){
  const lang=settings.lang||'en';
  const tx={
    'tab-editor': lang==='de'?'‚úèÔ∏è Editor':'‚úèÔ∏è Editor',
    'tab-player': lang==='de'?'‚ñ∂Ô∏è Spielen':'‚ñ∂Ô∏è Play',
    'tab-settings': lang==='de'?'‚öôÔ∏è Einstellungen':'‚öôÔ∏è Settings',
    'editorTitle': lang==='de'?'Fragen bearbeiten':'Edit Questions',
    'newQuestion': lang==='de'?'‚ûï Neue Frage':'‚ûï¬ï New question',
    'questionLabel': lang==='de'?'Frage':'Question',
    'questionText': {placeholder: lang==='de'?'Gib deine Frage ein':'Type your question'},
    'qImgPick': lang==='de'?'üñºÔ∏è Bild':'üñºÔ∏è Image',
    'qImgClear': lang==='de'?'Bild l√∂schen':'Clear image',
    'qAudPick': lang==='de'?'üîà Audio':'üîà Audio',
    'qAudClear': lang==='de'?'Audio l√∂schen':'Clear audio',
    'qVidPick': lang==='de'?'üìπ Video':'üìπ Video',
    'qVidClear': lang==='de'?'Video l√∂schen':'Clear video',
    'questionTypeLabel': lang==='de'?'Typ':'Type',
    'questionTypeSingle': lang==='de'?'Einzelauswahl':'Single Choice',
    'questionTypeMultiple': lang==='de'?'Mehrfachauswahl':'Multiple Choice',
    'questionTypeText': lang==='de'?'Antwort eingeben (Text)':'Enter Answer (text)',
    'questionTypeMultitext': lang==='de'?'Mehrere Texteingaben':'Multiple Text Inputs',
    'questionTypeMatching': lang==='de'?'Zuordnen (rechts ziehen)':'Matching (drag right)',
    'questionTypeOrder': lang==='de'?'In die richtige Reihenfolge bringen':'Put in the right order',
    'commentLabel': lang==='de'?'Kommentar (optional)':'Comment (optional)',
    'questionComment': {placeholder: lang==='de'?'Wird bei Feedback angezeigt, wenn aktiviert':'Shown with feedback when enabled'},
    'cImgPick': lang==='de'?'üñºÔ∏è Bild':'üñºÔ∏è Image',
    'cImgClear': lang==='de'?'Bild l√∂schen':'Clear image',
    'cAudPick': lang==='de'?'üîà Audio':'üîà¬à Audio',
    'cAudClear': lang==='de'?'Audio l√∂schen':'Clear audio',
    'cVidPick': lang==='de'?'üìπ Video':'üìπ Video',
    'cVidClear': lang==='de'?'Video l√∂schen':'Clear video',
    'categoryLabel': lang==='de'?'Kategorie / Thema (optional)':'Category / Topic (optional)',
    'catNoneOption': lang==='de'?'‚Äî keine ‚Äî¬î':'‚Äî none ‚Äî¬î',
    'saveQuestion': lang==='de'?'üíæ Frage speichern':'üíæ Save question',
    'cancelEdit': lang==='de'?'Abbrechen':'Cancel',
    'savedQuestionsTitle': lang==='de'?'Gespeicherte Fragen':'Saved Questions',
    'importBtn': lang==='de'?'üìÇ JSON importieren':'üìÇ Import JSON',
    'exportBtn': lang==='de'?'üíæ JSON exportieren':'üíæ Export JSON',
    'playerTitle': lang==='de'?'Quiz-Zeit':'Quiz Time',
    'settingsTitle': lang==='de'?'Einstellungen':'Settings',
    'themeLabel': lang==='de'?'Design ':'Theme ',
    'themeFormal': lang==='de'?'Formell':'Formal',
    'themePlayful': lang==='de'?'Verspielt':'Playful',
    'themeChild': lang==='de'?'Kinderfreundlich':'Child-friendly',
    'langLabel': lang==='de'?'Sprache ':'Language ',
    'feedbackHeading': lang==='de'?'Feedback':'Feedback',
    'feedbackImmediateLabel': lang==='de'?'Sofortiges Feedback':'Immediate feedback',
    'feedbackEndLabel': lang==='de'?'Feedback am Ende':'Feedback details at end',
    'showCorrectImmediateLabel': lang==='de'?'Richtige Antwort anzeigen (sofort)':'Show correct answer when wrong (immediate)',
    'showCommentsLabel': lang==='de'?'Kommentare anzeigen':'Show comments',
    'linkifyCommentsLabel': lang==='de'?'Links in Kommentaren aktivieren':'Linkify comment URLs',
    'validationHeading': lang==='de'?'Validierung':'Validation',
    'autoValidateLabel': lang==='de'?'Automatisch pr√ºfen (Standard)':'Validate automatically (default)',
    'randomHeading': lang==='de'?'Zufallsmodus':'Random mode',
    'randomModeLabel': lang==='de'?'Fragen zuf√§llig anordnen':'Randomize questions',
    'randomCountLabel': lang==='de'?'Anzahl der Fragen ':'Number of questions ',
    'timeHeading': lang==='de'?'Zeitlimit':'Time Limit',
    'timeLimitLabel': lang==='de'?'Zeit (Sekunden) ':'Time (seconds) ',
    'textMatchHeading': lang==='de'?'Textabgleich':'Text Matching',
    'caseSensitiveLabel': lang==='de'?'Gro√ü¬ü-/Kleinschreibung beachten':'Case sensitive',
    'ignorePunctLabel': lang==='de'?'Satzzeichen ignorieren':'Ignore punctuation',
    'normalizeAccentsLabel': lang==='de'?'Akzente normalisieren':'Normalize accents',
    'ignoreSpacesLabel': lang==='de'?'Leerzeichen zusammenfassen':'Collapse spaces',
    'regexFullLabel': lang==='de'?'Voller Regex-Abgleich (^...$)':'Full regex match (^...$)',
    'mcqHeading': lang==='de'?'Multiple-Choice-Bewertung':'Multiple Choice Scoring',
    'mcq_all': lang==='de'?'Alles oder nichts':'All-or-nothing',
    'mcq_partial': lang==='de'?'Teilpunkte':'Partial credit',
    'mcq_partial_penalty': lang==='de'?'Teilpunkte mit Abzug':'Partial with penalty',
    'speechHeading': lang==='de'?'Sprachausgabe':'Speech',
    'autoTTSQuestionsLabel': lang==='de'?'Automatische TTS f√ºr Fragen':'Auto-TTS questions',
    'autoTTSItemsLabel': lang==='de'?'Automatische TTS f√ºr Elemente/Optionen':'Auto-TTS items/options',
    'playModeHeading': lang==='de'?'Spielmodus':'Play mode',
    'showCategoryLabel': lang==='de'?'Kategorie w√§hrend des Spiels anzeigen':'Show category during play',
    'allowSkipLabel': lang==='de'?'√º¬úberspringen von Fragen erlauben':'Allow skipping questions',
    'catsToggle': lang==='de'?'Kategorien / Themen / Mottos':'Categories / Topics / Mottos',
    'saveSettings': lang==='de'?'Einstellungen speichern':'Save settings',
    'settingsSaved': lang==='de'?'Gespeichert ‚úì¬ì':'Saved ‚úì'
  };
  const specials={
    themeLabel:tx.themeLabel,
    langLabel:tx.langLabel,
    randomCountLabel:tx.randomCountLabel,
    timeLimitLabel:tx.timeLimitLabel
  };
  delete tx.themeLabel; delete tx.langLabel; delete tx.randomCountLabel; delete tx.timeLimitLabel;
  for(const [id,val] of Object.entries(tx)){
    const el=document.getElementById(id);
    if(!el) continue;
    if(typeof val==='string'){
      el.textContent=val;
    } else if(val.placeholder!==undefined){
      el.placeholder=val.placeholder;
    }
  }
  const th=document.getElementById('themeLabel'); if(th && th.childNodes[0]) th.childNodes[0].textContent=specials.themeLabel;
  const ll=document.getElementById('langLabel'); if(ll && ll.childNodes[0]) ll.childNodes[0].textContent=specials.langLabel;
  const rc=document.getElementById('randomCountLabel'); if(rc && rc.childNodes[0]) rc.childNodes[0].textContent=specials.randomCountLabel;
  const tl=document.getElementById('timeLimitLabel'); if(tl && tl.childNodes[0]) tl.childNodes[0].textContent=specials.timeLimitLabel;
}
let editingIndex = -1; // -1 means create new
function saveSettings(){ localStorage.setItem('quizSettings', JSON.stringify(settings)); }

let __keyHandlers=[];
function addKeyHandler(fn){ document.addEventListener('keydown', fn); __keyHandlers.push(fn); }
function clearKeyHandlers(){ __keyHandlers.forEach(h=>document.removeEventListener('keydown',h)); __keyHandlers=[]; }

// ===== Helpers =====
function el(tag, props={}, ...kids){ const n=document.createElement(tag); Object.assign(n, props); kids.forEach(k=> n.append(k?.nodeType? k : (k??''))); return n; }
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function normalizeText(s){
  let out = String(s ?? '');
  // Strip common combining marks without regex property escapes
  if(settings.normalizeAccents){
    try{
      out = out.normalize('NFD');
      let cleaned = '';
      for(const ch of out){
        const cp = ch.codePointAt(0);
        const isComb = (cp>=0x0300 && cp<=0x036F) || (cp>=0x1AB0 && cp<=0x1AFF) || (cp>=0x1DC0 && cp<=0x1DFF) || (cp>=0x20D0 && cp<=0x20FF) || (cp>=0xFE20 && cp<=0xFE2F);
        if(!isComb) cleaned += ch;
      }
      out = cleaned;
    }catch(e){}
  }
  // Remove punctuation/symbols: keep letters, digits, and whitespace
  if(settings.ignorePunct){
    let kept = '';
    for(const ch of out){
      const isLetter = (ch.toLowerCase() !== ch.toUpperCase());
      const isDigit = (ch >= '0' && ch <= '9');
      const isSpace = (ch.trim() === '');
      if(isLetter || isDigit || isSpace) kept += ch;
    }
    out = kept;
  }
  // Collapse spaces without regex
  if(settings.ignoreSpaces){
    let buf='', prevSpace=false;
    for(const ch of out){
      if(ch.trim()===''){
        if(!prevSpace){ buf += ' '; prevSpace=true; }
      } else { buf += ch; prevSpace=false; }
    }
    out = buf.trim();
  }
  if(!settings.caseSensitive){ out = out.toLowerCase(); }
  return out;
}
const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});
function miniAudio(url,label='Play'){ const b=document.createElement('button'); b.className='chip'; b.setAttribute('aria-pressed','false'); b.textContent='üîà '+label; const a=new Audio(url); b.onclick=()=>{ if(b.getAttribute('aria-pressed')==='true'){ a.pause(); a.currentTime=0; b.setAttribute('aria-pressed','false'); } else { a.play().catch(()=>{}); b.setAttribute('aria-pressed','true'); a.onended=()=>b.setAttribute('aria-pressed','false'); } }; return b; }
function miniVideo(url){ const v=document.createElement('video'); v.src=url; v.controls=true; v.className='thumb'; return v; }
function linkifyText(str){ const url=/https?:\/\/[^\s]+/g; const frag=document.createDocumentFragment(); let last=0; str=String(str||''); let m; while((m=url.exec(str))){ if(m.index>last) frag.appendChild(document.createTextNode(str.slice(last,m.index))); const a=document.createElement('a'); a.href=m[0]; a.target='_blank'; a.textContent=m[0]; frag.appendChild(a); last=m.index+m[0].length; } if(last<str.length) frag.appendChild(document.createTextNode(str.slice(last))); return frag; }

// ===== Media pickers (question/comment) =====
let qImgData='', qAudData='', qVidData='', cImgData='', cAudData='', cVidData='';
const qImg=document.getElementById('qImg'), qImgPick=document.getElementById('qImgPick'), qImgPrev=document.getElementById('qImgPrev'), qImgClear=document.getElementById('qImgClear');
qImgPick.onclick=()=>qImg.click();
qImg.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; qImgData=await fileToDataURL(f); qImgPrev.src=qImgData; qImgPrev.style.display='block'; qImgClear.style.display='inline-block'; };
qImgClear.onclick=()=>{ qImg.value=''; qImgData=''; qImgPrev.style.display='none'; qImgClear.style.display='none'; };
const qAud=document.getElementById('qAud'), qAudPick=document.getElementById('qAudPick'), qAudMini=document.getElementById('qAudMini'), qAudClear=document.getElementById('qAudClear');
qAudPick.onclick=()=>qAud.click();
qAud.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; qAudData=await fileToDataURL(f); qAudMini.innerHTML=''; qAudMini.appendChild(miniAudio(qAudData,'Audio')); qAudMini.style.display='inline-flex'; qAudClear.style.display='inline-block'; };
qAudClear.onclick=()=>{ qAud.value=''; qAudData=''; qAudMini.innerHTML=''; qAudMini.style.display='none'; qAudClear.style.display='none'; };
const qVid=document.getElementById('qVid'), qVidPick=document.getElementById('qVidPick'), qVidMini=document.getElementById('qVidMini'), qVidClear=document.getElementById('qVidClear');
qVidPick.onclick=()=>qVid.click();
qVid.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; qVidData=await fileToDataURL(f); qVidMini.innerHTML=''; qVidMini.appendChild(miniVideo(qVidData)); qVidMini.style.display='inline-flex'; qVidClear.style.display='inline-block'; };
qVidClear.onclick=()=>{ qVid.value=''; qVidData=''; qVidMini.innerHTML=''; qVidMini.style.display='none'; qVidClear.style.display='none'; };
const cImg=document.getElementById('cImg'), cImgPick=document.getElementById('cImgPick'), cImgPrev=document.getElementById('cImgPrev'), cImgClear=document.getElementById('cImgClear');
cImgPick.onclick=()=>cImg.click();
cImg.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; cImgData=await fileToDataURL(f); cImgPrev.src=cImgData; cImgPrev.style.display='block'; cImgClear.style.display='inline-block'; };
cImgClear.onclick=()=>{ cImg.value=''; cImgData=''; cImgPrev.style.display='none'; cImgClear.style.display='none'; };
const cAud=document.getElementById('cAud'), cAudPick=document.getElementById('cAudPick'), cAudMini=document.getElementById('cAudMini'), cAudClear=document.getElementById('cAudClear');
cAudPick.onclick=()=>cAud.click();
cAud.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; cAudData=await fileToDataURL(f); cAudMini.innerHTML=''; cAudMini.appendChild(miniAudio(cAudData,'Audio')); cAudMini.style.display='inline-flex'; cAudClear.style.display='inline-block'; };
cAudClear.onclick=()=>{ cAud.value=''; cAudData=''; cAudMini.innerHTML=''; cAudMini.style.display='none'; cAudClear.style.display='none'; };
const cVid=document.getElementById('cVid'), cVidPick=document.getElementById('cVidPick'), cVidMini=document.getElementById('cVidMini'), cVidClear=document.getElementById('cVidClear');
cVidPick.onclick=()=>cVid.click();
cVid.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; cVidData=await fileToDataURL(f); cVidMini.innerHTML=''; cVidMini.appendChild(miniVideo(cVidData)); cVidMini.style.display='inline-flex'; cVidClear.style.display='inline-block'; };
cVidClear.onclick=()=>{ cVid.value=''; cVidData=''; cVidMini.innerHTML=''; cVidMini.style.display='none'; cVidClear.style.display='none'; };

// ===== Editor renderers =====
const optHost = document.getElementById('questionOptionsContainer');
const qTypeSel = document.getElementById('questionType');
// ===== Categories / Topics (no global `quiz` needed) =====
// Simple slug from a label (for stable IDs)
function slugFromLabel(str){
  return String(str||'cat')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{Letter}\p{Number}]+/gu,'-')
    .replace(/^-+|-+$/g,'') || 'cat';
}

// Rebuilds the <select id="categorySelect">; adds a "New‚Ä¶" option that opens inline UI
function renderCategorySelect(){
  const sel = document.getElementById('categorySelect');
  const ui  = document.getElementById('categoryNewUI');
  if(!sel) return;

  const prev = sel.value;
  sel.innerHTML = '';

  const noneLbl = settings.lang==='de'?'‚Äî¬î keine ‚Äî':'‚Äî¬î none ‚Äî¬î';
  sel.appendChild(new Option(noneLbl,''));
  (meta.categories||[]).forEach(c=>{
    sel.appendChild(new Option(c.label||c.id, c.id));
  });
  sel.appendChild(new Option('‚ûï¬ï '+(settings.lang==='de'?'Neu‚Ä¶':'New‚Ä¶'),'__new__'));

  // restore previous selection if still present
  if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;

  // hook: show inline creator when "New‚Ä¶" is chosen
  sel.onchange = ()=>{
    if(sel.value === '__new__'){
      showNewCategoryUI();
    } else if(ui){
      ui.style.display = 'none';
      ui.innerHTML = '';
    }
  };
}

// Inline "create new category" UI shown under the select
function showNewCategoryUI(){
  const ui = document.getElementById('categoryNewUI');
  const sel = document.getElementById('categorySelect');
  if(!ui || !sel) return;

  ui.style.display = 'block';
  ui.innerHTML = '';

  const lang = (settings && settings.lang) || 'en';
  const nameIn = el('input',{type:'text', placeholder: lang==='de'?'Neuer Kategoriename':'New category name'});
  const idIn   = el('input',{type:'text', placeholder:'id (auto from name)'});
  const commentIn = el('input',{type:'text', placeholder: lang==='de'?'Kommentar (optional)':'Comment (optional)'});
  const create = el('button',{className:'btn btn-primary'}, lang==='de'?'Erstellen':'Create');
  const cancel = el('button',{className:'btn btn-ghost'}, lang==='de'?'Abbrechen':'Cancel');

  // auto-suggest id from name if empty
  nameIn.oninput = ()=>{ if(!idIn.value.trim()) idIn.value = slugFromLabel(nameIn.value); };

  create.onclick = ()=>{
    const label = nameIn.value.trim();
    const id    = (idIn.value.trim() || slugFromLabel(label));
    const comment  = commentIn.value.trim();
    if(!label){ alert(lang==='de'?'Bitte Namen eingeben':'Please enter a name'); return; }
    if(!meta.categories) meta.categories = [];
    if(meta.categories.some(c=>c.id===id)){ alert(lang==='de'?'ID existiert bereits':'ID already exists'); return; }

    meta.categories.push({ id, label, comment });
    saveMeta();

    renderCategorySelect();
    sel.value = id; // select the new one
    ui.style.display = 'none';
    ui.innerHTML = '';
  };

  cancel.onclick = ()=>{
    ui.style.display = 'none';
    ui.innerHTML = '';
    // revert selection back to none
    if(sel.value === '__new__') sel.value = '';
  };

  ui.append(el('div',{className:'row'}, nameIn, idIn, commentIn, create, cancel));
}

// (Optional) categories manager for Settings, if you have a <div id="catsManager">
function renderCategoriesManager(){
  const host = document.getElementById('catsManager');
  const panel = document.getElementById('catsPanel');
  if(!host) return;
  host.innerHTML = '';

  const lang=(settings&&settings.lang)||'en';
  host.appendChild(el('div',{className:'muted'}, lang==='de'? 'Definiere Kategorien/Themen. Jede hat eine ID, Bezeichnung und optionalen Kommentar.':'Define categories/topics. Each has an id, label, and optional comment.'));
  const list = el('div',{}); host.appendChild(list);

  (meta.categories||[]).forEach((c,idx)=>{
    const row = el('div',{className:'row',style:'flex-wrap:nowrap;align-items:center'});
    const idIn = el('input',{type:'text',value:c.id,placeholder:'id',style:'width:80px'});
    const labelIn = el('input',{type:'text',value:c.label||'',placeholder:lang==='de'?'Bezeichnung':'Label',style:'flex:1;width:auto'});
    const commentIn = el('input',{type:'text',value:c.comment||c.hint||'',placeholder:lang==='de'?'Kommentar (optional)':'Comment (optional)',style:'flex:1;width:auto'});
    const del  = el('button',{className:'btn btn-ghost',title:lang==='de'?'Entfernen':'Remove',onclick:()=>{
      meta.categories.splice(idx,1); saveMeta(); renderCategoriesManager(); renderCategorySelect();
    }},'üóëÔ∏è');

    idIn.oninput = ()=>{ c.id = idIn.value.trim(); saveMeta(); renderCategorySelect(); };
    labelIn.oninput = ()=>{ c.label = labelIn.value; saveMeta(); renderCategorySelect(); };
    commentIn.oninput = ()=>{ c.comment = commentIn.value; saveMeta(); };

    row.append(idIn,labelIn,commentIn,del);
    list.appendChild(row);
  });

  const add = el('button',{className:'btn'}, '‚ûï '+(lang==='de'?'Kategorie hinzuf√ºgen':'Add category'));
  add.onclick = ()=>{
    meta.categories.push({ id: slugFromLabel('Category '+((meta.categories?.length||0)+1)), label:'', comment:'' });
    saveMeta(); renderCategoriesManager(); renderCategorySelect();
  };
  host.appendChild(add);
  if(panel && panel.style.maxHeight && panel.style.maxHeight!=='0px') panel.style.maxHeight=panel.scrollHeight+'px';
}

// Initialize the dropdown at load:
document.addEventListener('DOMContentLoaded', renderCategorySelect);

// Small helpers
function mediaPickers(hostRow, init={}){
  const iFile=el('input',{type:'file',accept:'image/*',style:'display:none'});
  const aFile=el('input',{type:'file',accept:'audio/*',style:'display:none'});
  const vFile=el('input',{type:'file',accept:'video/*',style:'display:none'});
  const iBtn=el('button',{className:'chip',type:'button'},'üñºÔ∏è');
  const aBtn=el('button',{className:'chip',type:'button'},'üîà');
  const vBtn=el('button',{className:'chip',type:'button'},'üìπ');
  const prev=el('span',{});
  if(init.image){ prev.appendChild(el('img',{src:init.image,className:'thumb'})); hostRow.dataset.img=init.image; }
  if(init.audio){ prev.appendChild(miniAudio(init.audio,'Audio')); hostRow.dataset.aud=init.audio; }
  if(init.video){ prev.appendChild(miniVideo(init.video)); hostRow.dataset.vid=init.video; }
  iBtn.onclick=()=>iFile.click();
  aBtn.onclick=()=>aFile.click();
  vBtn.onclick=()=>vFile.click();
  iFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); hostRow.dataset.img=d; const old=prev.querySelector('img'); if(old) old.remove(); prev.prepend(el('img',{src:d,className:'thumb'})); };
  aFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); hostRow.dataset.aud=d; const old=prev.querySelector('.chip'); if(old) old.remove(); prev.appendChild(miniAudio(d,'Audio')); };
  vFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); hostRow.dataset.vid=d; const old=prev.querySelector('video'); if(old) old.remove(); prev.appendChild(miniVideo(d)); };
  return [iBtn,aBtn,vBtn,iFile,aFile,vFile,prev];
}

function answerRow(type, valueObj={}, idx, data){
  const row=el('div',{className:'row arow'});
  const correct=el('input',{type:type==='single'?'radio':'checkbox', name:'correct'});
  if(type==='single' && idx===(data.correct|0)) correct.checked=true;
  if(type==='multiple' && Array.isArray(data.corrects) && data.corrects.includes(idx)) correct.checked=true;
  const txt=el('input',{type:'text',placeholder:`Answer ${idx+1}`,value:valueObj.text||''});
  const hint=el('input',{type:'text',placeholder:'Hint (optional)',value:valueObj.hint||''});
  const mediaRow=el('span',{}); mediaPickers(mediaRow,{image:valueObj.image||'',audio:valueObj.audio||'',video:valueObj.video||''}).forEach(n=>mediaRow.appendChild(n));
  const del=el('button',{className:'btn btn-ghost',onclick:()=>row.remove()},'Remove');
  row.append(correct,txt,hint,mediaRow,del);
  return row;
}
function textRow(value){ const obj=(typeof value==='object'&&value)?value:{text:value||'',hint:''}; const r=el('div',{className:'row'}); const i=el('input',{type:'text',value:obj.text||'',placeholder:'Text'}); const h=el('input',{type:'text',value:obj.hint||'',placeholder:'Hint (optional)'}); const d=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove'); r.append(i,h,d); return r; }
function pairRow(p){ const r=el('div',{className:'row pair'});
  // LEFT
  const left=el('div',{className:'row',style:'flex:1;align-items:flex-start'});
  const lText=el('input',{type:'text',value:(p.left?.text||p.left||''),placeholder:'Left text'});
  const lHint=el('input',{type:'text',value:(p.left?.hint||''),placeholder:'Left hint (optional)'});
  const lMedia=el('span',{}); mediaPickers(lMedia,{image:p.left?.image||'',audio:p.left?.audio||'',video:p.left?.video||''}).forEach(n=>lMedia.appendChild(n));
  left.append(el('label',{},'Left'),lText,lHint,lMedia);
  // RIGHT
  const right=el('div',{className:'row',style:'flex:1;align-items:flex-start'});
  const rText=el('input',{type:'text',value:(p.right?.text||p.right||''),placeholder:'Right text'});
  const rHint=el('input',{type:'text',value:(p.right?.hint||''),placeholder:'Right hint (optional)'});
  const rMedia=el('span',{}); mediaPickers(rMedia,{image:p.right?.image||'',audio:p.right?.audio||'',video:p.right?.video||''}).forEach(n=>rMedia.appendChild(n));
  right.append(el('label',{},'Right'),rText,rHint,rMedia);
  const del=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove');
  r.append(left,right,del);
  return r;
}
function orderRow(it){ const o=(typeof it==='object'&&it)?it:{text:String(it||''),image:'',audio:'',hint:'',video:''}; const r=el('div',{className:'row order-row'}); const iText=el('input',{type:'text',value:o.text||'',placeholder:'Item text'}); const iHint=el('input',{type:'text',value:o.hint||'',placeholder:'Hint (optional)'}); const m=el('span',{}); mediaPickers(m,{image:o.image||'',audio:o.audio||'',video:o.video||''}).forEach(n=>m.appendChild(n)); const d=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove'); r.append(iText,iHint,m,d); return r; }

function renderOptionsEditor(data={}){
  if(!optHost||!qTypeSel) return; optHost.innerHTML='';
  const type=qTypeSel.value;
  if(type==='single' || type==='multiple'){
    const list=el('div',{id:'answersList'});
    const src=(data.answers&&data.answers.length? data.answers : [{text:''},{text:''},{text:''}]);
    src.forEach((ans,i)=> list.appendChild(answerRow(type, ans, i, data)) );
    const addBtn=el('button',{className:'btn',onclick:()=> list.appendChild(answerRow(type,{text:''}, list.querySelectorAll('.arow').length, data))}, '‚ûï Add answer');
    optHost.append(list, addBtn, el('div',{className:'muted'}, type==='single'?'Mark one correct.':'Mark all correct.'));
  }
  if(type==='text'){
    const list=el('div',{id:'txtAccept'});
    const src=(data.acceptable&&data.acceptable.length? data.acceptable : [{text:''}] );
    src.forEach(v=> list.appendChild(textRow(v)) );
    const add=el('button',{className:'btn',onclick:()=> list.appendChild(textRow({text:''}))}, '‚ûï Add acceptable');
    optHost.append(el('div',{className:'muted'},'Answers are compared using the Text Matching settings.'), list, add);
  }
  if(type==='multitext'){
    const list=el('div',{id:'multiPrompts'});
    (data.prompts&&data.prompts.length?data.prompts:[{text:'Answer 1'},{text:'Answer 2'}]).forEach(lbl=> list.appendChild(textRow(lbl)) );
    const add=el('button',{className:'btn',onclick:()=> list.appendChild(textRow({text:''}))}, '‚ûï Add field');
    optHost.append(el('div',{className:'muted'},'Player must fill all fields.'), list, add);
  }
  if(type==='matching'){
    const wrap=el('div',{id:'pairsWrap'});
    (data.pairs&&data.pairs.length? data.pairs : [{left:{text:''},right:{text:''}}]).forEach(p=> wrap.appendChild(pairRow(p)) );
    const add=el('button',{className:'btn',onclick:()=> wrap.appendChild(pairRow({left:{text:''},right:{text:''}}))}, '‚ûï¬ï Add pair');
    optHost.append(el('div',{className:'muted'},'In play, drag RIGHT to match LEFT.'), wrap, add);
  }
  if(type==='order'){
    const list=el('div',{id:'orderList'});
    (data.sequence&&data.sequence.length? data.sequence : [{text:''},{text:''}]).forEach(it=> list.appendChild(orderRow(it)) );
    const add=el('button',{className:'btn',onclick:()=> list.appendChild(orderRow({text:''}))}, '‚ûï Add item');
    optHost.append(el('div',{className:'muted'},'Correct order is the list order here.'), list, add);
  }
}

qTypeSel.addEventListener('change', ()=>renderOptionsEditor());
renderOptionsEditor();

// Gather editor data
function collectQuestion(){
  const type=qTypeSel.value; const question=document.getElementById('questionText').value.trim();
  const q={type, question, questionMedia:{image:qImgData||'', audio:qAudData||'', video:qVidData||''}, comment:(document.getElementById('questionComment').value||'').trim(), commentMedia:{image:cImgData||'', audio:cAudData||'', video:cVidData||''}};
  const catSel=document.getElementById('categorySelect'); if(catSel && catSel.value) q.categoryId=catSel.value;
  if(type==='single' || type==='multiple'){
    const rows=[...optHost.querySelectorAll('#answersList .arow')];
    const answers=rows.map(r=>({text:r.querySelector('input[type="text"]').value.trim(), image:r.dataset.img||'', audio:r.dataset.aud||'', video:r.dataset.vid||''})).filter(a=>a.text||a.image||a.audio||a.video);
    if(type==='single'){ const idx=rows.findIndex(r=> r.querySelector('input[type="radio"]').checked); Object.assign(q,{answers,correct:idx}); }
    else { const corrects=rows.map((r,i)=> r.querySelector('input[type="checkbox"]').checked? i : -1).filter(i=>i!==-1); Object.assign(q,{answers,corrects}); }
  }
  if(type==='text'){ q.acceptable=[...optHost.querySelectorAll('#txtAccept input[type="text"]')].map(i=>i.value.trim()).filter(Boolean); }
  if(type==='multitext'){ q.prompts=[...optHost.querySelectorAll('#multiPrompts input[type="text"]')].map(i=>i.value.trim()).filter(Boolean); }
  if(type==='matching'){
    q.pairs=[...optHost.querySelectorAll('#pairsWrap .pair')].map(row=>{
      const leftWrap=row.children[0];
      const rightWrap=row.children[1];
      const lText=leftWrap.querySelector('input[type="text"]').value.trim();
      const lMedia=leftWrap.querySelector('.row');
      const rText=rightWrap.querySelector('input[type="text"]').value.trim();
      const rMedia=rightWrap.querySelector('.row');
      return {
        left:{text:lText, image:lMedia?.dataset?.img||'', audio:lMedia?.dataset?.aud||'', video:lMedia?.dataset?.vid||''},
        right:{text:rText, image:rMedia?.dataset?.img||'', audio:rMedia?.dataset?.aud||'', video:rMedia?.dataset?.vid||''}
      };
    }).filter(p=> (p.left.text||p.left.image||p.left.audio||p.left.video||p.right.text||p.right.image||p.right.audio||p.right.video));
  }
  if(type==='order'){
    q.sequence=[...optHost.querySelectorAll('#orderList .order-row')].map(r=>{
      const t=r.querySelector('input[type="text"]').value.trim();
      const m=r.querySelector('.row');
      return { text:t, image:m?.dataset?.img||'', audio:m?.dataset?.aud||'', video:m?.dataset?.vid||'' };
    }).filter(it=> it.text||it.image||it.audio||it.video);
  }
  return q;
}

// Load into editor (incl. media)
function loadIntoEditor(q){
  document.getElementById('questionText').value=q.question||'';
  document.getElementById('questionComment').value=q.comment||'';
  qImgData=q.questionMedia?.image||''; qAudData=q.questionMedia?.audio||''; qVidData=q.questionMedia?.video||''; cImgData=q.commentMedia?.image||''; cAudData=q.commentMedia?.audio||''; cVidData=q.commentMedia?.video||'';
  if(qImgData){ qImgPrev.src=qImgData; qImgPrev.style.display='block'; qImgClear.style.display='inline-block'; } else { qImgPrev.style.display='none'; qImgClear.style.display='none'; }
  if(qAudData){ qAudMini.innerHTML=''; qAudMini.appendChild(miniAudio(qAudData,'Audio')); qAudMini.style.display='inline-flex'; qAudClear.style.display='inline-block'; } else { qAudMini.innerHTML=''; qAudMini.style.display='none'; qAudClear.style.display='none'; }
  if(qVidData){ qVidMini.innerHTML=""; qVidMini.appendChild(miniVideo(qVidData)); qVidMini.style.display="inline-flex"; qVidClear.style.display="inline-block"; } else { qVidMini.innerHTML=""; qVidMini.style.display="none"; qVidClear.style.display="none"; }
  if(cImgData){ cImgPrev.src=cImgData; cImgPrev.style.display='block'; cImgClear.style.display='inline-block'; } else { cImgPrev.style.display='none'; cImgClear.style.display='none'; }
  if(cAudData){ cAudMini.innerHTML=''; cAudMini.appendChild(miniAudio(cAudData,'Audio')); cAudMini.style.display='inline-flex'; cAudClear.style.display='inline-block'; } else { cAudMini.innerHTML=''; cAudMini.style.display='none'; cAudClear.style.display='none'; }
  if(cVidData){ cVidMini.innerHTML=""; cVidMini.appendChild(miniVideo(cVidData)); cVidMini.style.display="inline-flex"; cVidClear.style.display="inline-block"; } else { cVidMini.innerHTML=""; cVidMini.style.display="none"; cVidClear.style.display="none"; }
  qTypeSel.value=q.type||'single'; renderOptionsEditor(q);
  renderCategorySelect(); if(q.categoryId){ const sel=document.getElementById('categorySelect'); if(sel) sel.value=q.categoryId; }
}

function clearEditorFields(){
  document.getElementById('questionText').value='';
  document.getElementById('questionComment').value='';
  qImg.value=''; qAud.value=''; qVid.value=''; cImg.value=''; cAud.value=''; cVid.value='';
  qImgData=qAudData=qVidData=cImgData=cAudData=cVidData='';
  qImgPrev.style.display='none'; qImgClear.style.display='none';
  qAudMini.innerHTML=''; qAudMini.style.display='none'; qAudClear.style.display='none';
  qVidMini.innerHTML=''; qVidMini.style.display='none'; qVidClear.style.display='none';
  cImgPrev.style.display='none'; cImgClear.style.display='none';
  cAudMini.innerHTML=''; cAudMini.style.display='none'; cAudClear.style.display='none';
  cVidMini.innerHTML=''; cVidMini.style.display='none'; cVidClear.style.display='none';
  const sel=document.getElementById('categorySelect'); if(sel) sel.value='';
  qTypeSel.value='single';
  renderOptionsEditor();
  editingIndex=-1;
}


function showEditorForm(){
  document.getElementById('editorForm').style.display='block';
}

function hideEditorForm(){
  document.getElementById('editorForm').style.display='none';
}

// Save / list
function renderQuestionList(){
  const ul=document.getElementById('questionList'); ul.innerHTML='';
  questions.forEach((q,i)=>{
    const li=el('li',{className:'question-item'});
    li.dataset.index=i;
    const content=el('div',{className:'q-content'});
    const title=el('span',{className:'q-title'}, q.question||'(untitled)');
    content.append(title);
    if(q.questionMedia?.image){ content.appendChild(el('img',{src:q.questionMedia.image,className:'tiny-thumb'})); }
    if(q.questionMedia?.audio){ content.appendChild(el('span',{className:'media-icon'},'üîà')); }
        if(q.questionMedia?.video){ content.appendChild(el('span',{className:'media-icon'},'üìπ')); }
    li.append(content);
    const actions=el('div',{className:'question-actions'});
    const edit=el('button',{},'‚úèÔ∏è');
    edit.onclick=()=>{
      editingIndex=i;
      loadIntoEditor(q);
      showEditorForm();
      document.getElementById('editor').scrollIntoView({behavior:'smooth'});
    };
    const del=el('button',{},'üóëÔ∏è'); del.onclick=()=>{ questions.splice(i,1); localStorage.setItem('quizData', JSON.stringify(questions)); renderQuestionList(); };
    actions.append(edit,del); li.append(actions); ul.append(li);
  });
  // drag reorder
  [...ul.querySelectorAll('.question-item')].forEach(li=>{
    li.draggable=true;
    li.addEventListener('dragstart',e=>{ li.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    li.addEventListener('dragend',e=>{ li.classList.remove('dragging'); saveReorder(); });
    li.addEventListener('dragover',e=>{ e.preventDefault(); const t=e.currentTarget; const d=document.querySelector('.dragging'); if(d&&t!==d){ const r=t.getBoundingClientRect(); const after=(e.clientY-r.top)/r.height>0.5; t.parentNode.insertBefore(d, after?t.nextSibling:t); }});
  });
}
renderQuestionList();

document.getElementById('saveQuestion').onclick=()=>{
  const lang=settings.lang||'en';
  const qtext=document.getElementById('questionText').value.trim(); if(!qtext) { alert(lang==='de'?'Frage eingeben':'Enter a question'); return; }
  const q=collectQuestion();
  if(q.type==='single'&& (q.correct==null||q.correct<0)) { alert(lang==='de'?'Markiere die richtige Antwort':'Mark the correct answer'); return; }
  if(q.type==='multiple'&& (!q.corrects||!q.corrects.length)) { alert(lang==='de'?'Markiere mindestens eine richtige':'Mark at least one correct'); return; }
  if(q.type==='text'&& (!q.acceptable||!q.acceptable.length)) { alert(lang==='de'?'F√ºge mindestens eine akzeptierte Antwort hinzu':'Add at least one acceptable'); return; }
  if(q.type==='matching'&& (!q.pairs||!q.pairs.length)) { alert(lang==='de'?'F√ºge mindestens ein Paar hinzu':'Add at least one pair'); return; }
  if(q.type==='order'&& (!q.sequence||q.sequence.length<2)) { alert(lang==='de'?'F√ºge mindestens zwei Elemente hinzu':'Add at least two items'); return; }
  q.comment=document.getElementById('questionComment').value.trim();
  if(editingIndex>=0){ questions[editingIndex]=q; }
  else questions.push(q);
  localStorage.setItem('quizData', JSON.stringify(questions)); renderQuestionList();
  clearEditorFields();
  hideEditorForm();
};

document.getElementById('cancelEdit').onclick=()=>{
  clearEditorFields();
  hideEditorForm();
};

document.getElementById('newQuestion').onclick=()=>{
  clearEditorFields();
  showEditorForm();
  document.getElementById('editor').scrollIntoView({behavior:'smooth'});
};

function saveReorder(){ const ul=document.getElementById('questionList'); questions=[...ul.children].map(li=>questions[parseInt(li.dataset.index,10)]); localStorage.setItem('quizData', JSON.stringify(questions)); renderQuestionList(); }

// ===== Settings =====
function applySettingsToUI(){
  document.getElementById('feedbackImmediate').checked=settings.feedbackImmediate; document.getElementById('feedbackEnd').checked=settings.feedbackEnd; document.getElementById('showComments').checked=settings.showComments; document.getElementById('linkifyComments').checked=settings.linkifyComments; document.getElementById('autoValidate').checked=settings.autoValidate;
  document.getElementById('themeSelect').value=settings.theme; document.body.setAttribute('data-theme', settings.theme);
  document.getElementById('langSelect').value=settings.lang;
  document.getElementById('randomMode').checked=settings.random; document.getElementById('randomCount').value=settings.randomCount||''; document.getElementById('timeLimitSec').value=settings.timeLimitSec||0;
  document.getElementById('caseSensitive').checked=settings.caseSensitive; document.getElementById('ignorePunct').checked=settings.ignorePunct; document.getElementById('normalizeAccents').checked=settings.normalizeAccents; document.getElementById('ignoreSpaces').checked=settings.ignoreSpaces; document.getElementById('regexFull').checked=settings.regexFull; document.getElementById('mcqScore').value=settings.mcqScore; document.getElementById('autoTTSQuestions').checked=settings.autoTTSQuestions; document.getElementById('autoTTSItems').checked=settings.autoTTSItems; document.getElementById('showCorrectImmediate').checked=settings.showCorrectImmediate;
  document.getElementById('showCategory').checked=settings.showCategory; document.getElementById('allowSkip').checked=settings.allowSkip;
  renderCategorySelect();
  renderCategoriesManager();
  applyLang();
}
applySettingsToUI();

const catsToggle=document.getElementById('catsToggle');
const catsPanel=document.getElementById('catsPanel');
if(catsToggle && catsPanel){
  catsToggle.onclick=()=>{
    const open=catsPanel.style.maxHeight && catsPanel.style.maxHeight!=='0px';
    if(open){ catsPanel.style.maxHeight='0'; }
    else { catsPanel.style.maxHeight=catsPanel.scrollHeight+'px'; }
  };
}

document.getElementById('saveSettings').onclick=()=>{
  settings.feedbackImmediate=document.getElementById('feedbackImmediate').checked;
  settings.feedbackEnd=document.getElementById('feedbackEnd').checked;
  settings.showComments=document.getElementById('showComments').checked;
  settings.linkifyComments=document.getElementById('linkifyComments').checked;
  settings.autoValidate=document.getElementById('autoValidate').checked;
  settings.theme=document.getElementById('themeSelect').value;
  document.body.setAttribute('data-theme', settings.theme);
  settings.lang=document.getElementById('langSelect').value;
  settings.random=document.getElementById('randomMode').checked;
  settings.randomCount=parseInt(document.getElementById('randomCount').value||'0');
  settings.timeLimitSec=parseInt(document.getElementById('timeLimitSec').value||'0');
  settings.caseSensitive=document.getElementById('caseSensitive').checked;
  settings.ignorePunct=document.getElementById('ignorePunct').checked;
  settings.normalizeAccents=document.getElementById('normalizeAccents').checked;
  settings.ignoreSpaces=document.getElementById('ignoreSpaces').checked;
  settings.regexFull=document.getElementById('regexFull').checked;
  settings.mcqScore=document.getElementById('mcqScore').value;
  settings.autoTTSQuestions=document.getElementById('autoTTSQuestions').checked;
  settings.autoTTSItems=document.getElementById('autoTTSItems').checked;
  settings.showCorrectImmediate=document.getElementById('showCorrectImmediate').checked;
  settings.showCategory=document.getElementById('showCategory').checked;
  settings.allowSkip=document.getElementById('allowSkip').checked;
  document.documentElement.lang = settings.lang || 'en';
  applyLang();
  renderCategorySelect();
  renderCategoriesManager();
  saveSettings();
  const s=document.getElementById('settingsSaved');
  s.style.display='inline';
  setTimeout(()=>s.style.display='none',1200);
};

// ===== Tabs =====
function showTab(id){ ['editor','player','settings'].forEach(x=>document.getElementById(x).style.display=x===id?'block':'none'); }

document.getElementById('tab-editor').onclick=()=>{ showTab('editor'); renderQuestionList(); };
document.getElementById('tab-player').onclick=()=>{ showTab('player'); startQuiz(); };
document.getElementById('tab-settings').onclick=()=>{ showTab('settings'); };

// ===== Import/Export override to include categories =====
(function(){
  const impFile=document.getElementById('importFile');
  const importBtn=document.getElementById('importBtn');
  const exportBtn=document.getElementById('exportBtn');
  if(importBtn){ importBtn.onclick=()=> impFile.click(); }
  if(impFile){ impFile.onchange=(ev)=>{ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ try{ const data=JSON.parse(e.target.result);
    if(Array.isArray(data)) {
      questions=data;
    } else if(data && Array.isArray(data.questions)) {
      questions=data.questions;
      meta.categories = Array.isArray(data.categories)? data.categories : (data.meta&&Array.isArray(data.meta.categories)? data.meta.categories : meta.categories);
    } else {
      throw new Error('Invalid JSON');
    }
    meta.categories = (meta.categories||[]).map(c=> ({id:c.id, label:(c.label||c.labels?.en||c.labels?.de||c.id), comment:c.comment||c.hint||''}));
    localStorage.setItem('quizData', JSON.stringify(questions)); localStorage.setItem('quizMeta', JSON.stringify(meta));
    renderQuestionList(); renderCategorySelect(); renderCategoriesManager(); alert('Imported ‚úì'); }catch(err){ alert('Import failed: '+err.message); } }; r.readAsText(f); };
  }
  if(exportBtn){ exportBtn.onclick=()=>{ const payload={ categories: meta.categories, questions }; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz.json'; a.click(); }; }
})();

// ===== Speech =====
function maybeSpeakItemText(text, target){ if(settings.autoTTSItems && text){ if(target && target.closest('.chip')) return; speak(text); } }

// ===== Player =====
let __playState={pool:[],idx:0,correct:0,results:[],timerId:null};

function startQuiz(){
  const qc=document.getElementById('quizContainer'); const qctrl=document.getElementById('quizControls');
  qc.innerHTML=''; qctrl.innerHTML='';
  if(!questions.length){ qc.innerHTML='<p class="muted">No questions yet.</p>'; return; }
  __playState.pool = settings.random? shuffle(questions).slice(0, Math.max(1, settings.randomCount||questions.length)) : questions.slice();
  __playState.idx=0; __playState.correct=0; __playState.results=[];
  showCurrent();
}

function showCurrent(){
  const qc=document.getElementById('quizContainer'); const qctrl=document.getElementById('quizControls');
  clearKeyHandlers();
  qc.innerHTML=''; qctrl.innerHTML='';
  if(__playState.timerId){ clearInterval(__playState.timerId); __playState.timerId=null; }
  const q=__playState.pool[__playState.idx]; if(!q){ finalize(); return; }
  if(settings.showCategory && q.categoryId){
    const cat=(meta.categories||[]).find(c=>c.id===q.categoryId);
    if(cat){
      const wrap=el('div',{className:'muted'}, cat.label||cat.id);
      qc.appendChild(wrap);
      const cm=cat.comment||cat.hint;
      if(cm) qc.appendChild(el('p',{className:'muted'}, cm));
    }
  }
  const title=el('h3',{}, q.question); title.onclick=()=>speak(q.question); qc.appendChild(title); if(settings.autoTTSQuestions) speak(q.question);
  if(q.questionMedia?.image){ qc.appendChild(el('img',{src:q.questionMedia.image,className:'thumb'})); }
  if(q.questionMedia?.audio){ qc.appendChild(miniAudio(q.questionMedia.audio,'Question audio')); }
    if(q.questionMedia?.video){ qc.appendChild(miniVideo(q.questionMedia.video)); }

  if(q.type==='single') renderPlaySingle(q, qc, qctrl);
  else if(q.type==='multiple') renderPlayMultiple(q, qc, qctrl);
  else if(q.type==='text') renderPlayText(q, qc, qctrl);
  else if(q.type==='matching') renderPlayMatching(q, qc, qctrl);
  else if(q.type==='order') renderPlayOrder(q, qc, qctrl);
  else if(q.type==='multitext') renderPlayMultiText(q, qc, qctrl);
  if(settings.timeLimitSec>0){
    let remaining=settings.timeLimitSec;
    const tEl=el('div',{id:'timer'}, '‚è± '+remaining);
    qc.prepend(tEl);
    __playState.timerId=setInterval(()=>{
      remaining--;
      const elT=document.getElementById('timer');
      if(elT) elT.textContent='‚è± '+remaining;
      if(remaining<=0){
        clearInterval(__playState.timerId); __playState.timerId=null;
        proceed(false, q, t('time'));
      }
    },1000);
  }
  if(settings.allowSkip){ const sk=el('button',{className:'btn',onclick:skipQuestion}, t('skip')); qctrl.appendChild(sk); }
}

function proceed(ok, q, msg='', opts={}){
  const qc=document.getElementById('quizContainer'); const qctrl=document.getElementById('quizControls');
  clearKeyHandlers();
  if(__playState.timerId){ clearInterval(__playState.timerId); __playState.timerId=null; }
  __playState.results.push({q, ok});
  if(settings.feedbackImmediate){
    const b=el('div',{className:'banner '+(ok?'ok':'err')}, msg || (ok? t('correct') : t('wrong')));
    if((!ok || opts.showCorrect) && settings.showCorrectImmediate){
      const corr=describeCorrect(q);
      if(corr){ b.appendChild(el('div',{className:'muted'}, corr)); }
    }
    if(settings.showComments && (q.comment || q.commentMedia?.image || q.commentMedia?.audio || q.commentMedia?.video)){ const c=el('div',{className:'muted'}); if(q.comment){ if(settings.linkifyComments) c.appendChild(linkifyText(q.comment)); else c.textContent=q.comment; } if(q.commentMedia?.image) c.appendChild(el('div',{}, el('img',{src:q.commentMedia.image,className:'thumb'}))); if(q.commentMedia?.audio) c.appendChild(miniAudio(q.commentMedia.audio,'Comment audio')); if(q.commentMedia?.video) c.appendChild(miniVideo(q.commentMedia.video)); b.appendChild(c); }
    qc.appendChild(b);
    qctrl.innerHTML='';
    let advanced=false;
    const go=()=>{ if(advanced) return; advanced=true; nextQuestion(); };
    const nx=el('button',{className:'btn btn-primary',onclick:go}, t('next'));
    qctrl.appendChild(nx);
    nx.focus();
    addKeyHandler(e=>{ if(e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); go(); } });
  } else { nextQuestion(); }
  if(ok) __playState.correct++;
}

function nextQuestion(){ __playState.idx++; if(__playState.idx>=__playState.pool.length) finalize(); else showCurrent(); }
function skipQuestion(){ if(__playState.timerId){ clearInterval(__playState.timerId); __playState.timerId=null; } const q=__playState.pool.splice(__playState.idx,1)[0]; __playState.pool.push(q); showCurrent(); }
function finalize(){
  const qc=document.getElementById('quizContainer'); const qctrl=document.getElementById('quizControls');
  qc.innerHTML=''; qctrl.innerHTML='';
  qc.appendChild(el('h3',{}, `${t('score')}: ${__playState.correct} / ${__playState.pool.length}`));
  if(settings.feedbackEnd){
    const list=el('ul',{style:'list-style:none;padding-left:0'});
    __playState.results.forEach((r,i)=>{
      const li=el('li',{}, `${i+1}. ${r.q.question}`);
      li.appendChild(el('span',{className:'muted'}, r.ok?' ‚úì':' ‚úó¬ó'));
      const corr=describeCorrect(r.q);
      if(corr) li.appendChild(el('div',{className:'muted'}, corr));
      if(settings.showComments && (r.q.comment || r.q.commentMedia?.image || r.q.commentMedia?.audio || r.q.commentMedia?.video)){
        const c=el('div',{className:'muted'});
        if(r.q.comment){
          if(settings.linkifyComments) c.appendChild(linkifyText(r.q.comment)); else c.textContent=r.q.comment;
        }
        if(r.q.commentMedia?.image) c.appendChild(el('div',{}, el('img',{src:r.q.commentMedia.image,className:'thumb'})));
        if(r.q.commentMedia?.audio) c.appendChild(miniAudio(r.q.commentMedia.audio,'Comment audio'));
        if(r.q.commentMedia?.video) c.appendChild(miniVideo(r.q.commentMedia.video));
        li.appendChild(c);
      }
      list.appendChild(li);
    });
    qc.appendChild(list);
  }
}

// Media-aware renderer for items
function renderPlayItem(item){ const box=el('div',{}); const text=(item?.text??''); const img=(item?.image||''); const aud=(item?.audio||''); const vid=(item?.video||''); if(img) box.appendChild(el('img',{src:img,className:'thumb'})); if(text) box.appendChild(el('div',{}, text)); if(aud) box.appendChild(miniAudio(aud,'Play')); if(vid) box.appendChild(miniVideo(vid)); box.addEventListener('click',ev=> maybeSpeakItemText(text, ev.target)); return box; }

// ===== Helpers for feedback =====
function describeCorrect(q){
  try{
    const lang=settings.lang||'en';
    if(q.type==='single'){
      const a=q.answers?.[q.correct]; if(!a) return ''; return (lang==='de'?'Richtige Antwort: ':'Correct answer: ')+(a.text||'(media)');
    }
    if(q.type==='multiple'){
      const idxs=q.corrects||[]; const texts=idxs.map(i=> q.answers?.[i]?.text||'(media)').filter(Boolean); return (lang==='de'?'Richtige Antworten: ':'Correct answers: ')+texts.join(', ');
    }
    if(q.type==='text'){
      const acc=q.acceptable||[]; const first=acc[0]; if(!first) return ''; const txt= typeof first==='object'? first.text : first; return (lang==='de'?'Korrekte Antwort: ':'Correct answer: ')+txt;
    }
    if(q.type==='matching'){
      const pairs=q.pairs||[]; const lines=pairs.map(p=> (p.left?.text||p.left||'(media)')+' ‚Üí '+(p.right?.text||p.right||'(media)')); return (lang==='de'?'Paare: ':'Pairs: ')+lines.join(' | ');
    }
    if(q.type==='order'){
      const seq=q.sequence||[]; const t=seq.map(s=> s?.text||s||'(media)'); return (lang==='de'?'Reihenfolge: ':'Order: ')+t.join(' ‚Üí ');
    }
    if(q.type==='multitext'){
      const ans=(q.prompts||[]).map(p=> (p?.text||p||'')).filter(Boolean);
      return ans.length? t('answers')+': '+ans.join(', ') : '';
    }
  }catch(e){ return ''; }
}

// ===== Play renderers + validation =====
function renderPlaySingle(q, qc, qctrl){
  q.answers = (q.answers||[]);
  const btns=[];
  let chosen=-1;
  let submitted=false;
  const submit=()=>{
    if(submitted) return;
    submitted=true;
    btns.forEach(b=>b.disabled=true);
    proceed(chosen===q.correct, q);
  };
  let submitBtn=null;
  q.answers.forEach((a,i)=>{
    const b = el('button',{className:'btn opt'});
    const box = el('div',{});
    if(a.image) box.appendChild(el('img',{src:a.image,className:'thumb'}));
    if(a.text) box.appendChild(el('div',{}, a.text));
    if(a.audio) box.appendChild(miniAudio(a.audio,'Play'));
    if(a.video) box.appendChild(miniVideo(a.video));
    if(a.hint){
      const hintBtn = el('button',{className:'chip',type:'button'},'üí°');
      const hintText = el('span',{className:'muted',style:'display:none;margin-left:6px'}, a.hint);
      hintBtn.onclick = ()=>{ hintText.style.display = (hintText.style.display==='none'?'inline':'none'); };
      box.appendChild(hintBtn);
      box.appendChild(hintText);
    }
    b.appendChild(box);
    b.onclick = ()=>{
      if(submitted) return;
      if(settings.autoTTSItems && a.text) speak(a.text);
      chosen=i;
      if(settings.autoValidate){
        submit();
      }else{
        btns.forEach(btn=>btn.classList.remove('selected'));
        b.classList.add('selected');
        if(!submitBtn){
          submitBtn=el('button',{className:'btn btn-primary'}, t('submit'));
          submitBtn.onclick=submit;
          qctrl.appendChild(submitBtn);
        }
      }
    };
    qc.appendChild(b); btns.push(b);
  });
  addKeyHandler(e=>{ const idx=parseInt(e.key,10)-1; if(idx>=0 && idx<btns.length) btns[idx].click(); });
}

function renderPlayMultiple(q, qc, qctrl){
  q.answers=(q.answers||[]);
  const checks=q.answers.map((a,i)=>{
    const row=el('div',{});
    const chk=el('input',{type:'checkbox'});
    const label=el('span',{}, ' ', a.text||'');
    row.append(chk,label);
    if(a.image) row.appendChild(el('img',{src:a.image,className:'thumb'}));
    if(a.audio) row.appendChild(miniAudio(a.audio,'Play'));
    if(a.video) row.appendChild(miniVideo(a.video));
    if(a.hint){ const hBtn=el('button',{className:'chip',type:'button'},'üí°'); const hTxt=el('span',{className:'muted',style:'display:none;margin-left:6px'},a.hint); hBtn.onclick=()=>{ hTxt.style.display=hTxt.style.display==='none'?'inline':'none'; }; row.append(hBtn,hTxt); }
    if(settings.autoTTSItems && a.text) row.onclick=()=>speak(a.text);
    qc.appendChild(row);
    return chk;
  });
  const s=el('button',{className:'btn btn-primary'}, t('submit'));
  s.onclick=()=>{
    const chosen=checks.map((c,i)=>c.checked?i:-1).filter(i=>i!==-1);
    const corrects=(q.corrects||[]).slice();
    let ok=false;
    if(settings.mcqScore==='all'){
      ok = (chosen.slice().sort().join(',')===corrects.slice().sort().join(','));
    } else {
      const total=Math.max(1,corrects.length);
      const got=chosen.filter(i=>corrects.includes(i)).length;
      const wrong=chosen.filter(i=>!corrects.includes(i)).length;
      let score=got/total;
      if(settings.mcqScore==='partial_penalty') score=Math.max(0,score - wrong/total);
      ok=score>=0.999;
    }
    proceed(ok,q);
  };
  qctrl.appendChild(s);
  addKeyHandler(e=>{ if(e.key>='1' && e.key<='9'){ const idx=parseInt(e.key,10)-1; if(checks[idx]) checks[idx].checked=!checks[idx].checked; } else if(e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); s.click(); } });
}

function renderPlayText(q, qc, qctrl){
  const inp = el('input',{type:'text',placeholder:'Your answer'});
  qc.appendChild(inp);

  const acceptable = (q.acceptable||[]).map(a => typeof a==='string' ? {text:a, hint:''} : a);
  const hintAll = acceptable.map(a=>a.hint).filter(Boolean).join(' ¬∑ ');
  if(hintAll){
    const hBtn = el('button',{className:'chip',type:'button'},'üí°');
    const hTxt = el('span',{className:'muted',style:'display:none;margin-left:6px'}, hintAll);
    hBtn.onclick = ()=>{ hTxt.style.display = hTxt.style.display==='none' ? 'inline' : 'none'; };
    qc.append(hBtn,hTxt);
  }

  const check = ()=>{ const u = normalizeText(inp.value); return acceptable.some(a=> normalizeText(a.text)===u ); };
  const s = el('button',{className:'btn btn-primary'}, t('submit'));
  let submitted=false;
  const submit=()=>{ if(submitted) return; submitted=true; inp.disabled=true; s.disabled=true; proceed(check(), q); };
  s.onclick = submit;
  qctrl.appendChild(s);
  inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); submit(); }});
}


function renderPlayMatching(q, qc, qctrl){
  const pairs = Array.isArray(q.pairs)? q.pairs : [];
  const leftObjs = pairs.map(p=> (typeof p.left==='object'? p.left : {text:p.left||''}));
  const rightObjs = pairs.map((p,i)=> { const ro=(typeof p.right==='object'? p.right : {text:p.right||''}); return Object.assign({key:String(i)}, ro); });
  const sh = shuffle(rightObjs.slice());

  const grid = el('div',{className:'grid2'});
  const leftCol = el('div',{});
  const rightCol = el('ul',{className:'sort-list'});

  leftObjs.forEach(obj=>{
    const card=el('div',{className:'question-item',style:'cursor:default'});
    if(obj.image) card.appendChild(el('img',{src:obj.image,className:'thumb'}));
    if(obj.text) card.appendChild(el('div',{},obj.text));
    if(obj.audio) card.appendChild(miniAudio(obj.audio,'Play'));
    if(obj.video) card.appendChild(miniVideo(obj.video));
    if(obj.hint){ const hb=el('button',{className:'chip',type:'button'},'üí°'); const ht=el('span',{className:'muted',style:'display:none;margin-left:6px'},obj.hint); hb.onclick=()=>{ ht.style.display=ht.style.display==='none'?'inline':'none'; }; card.append(hb,ht); }
    leftCol.appendChild(card);
  });

  sh.forEach(it=>{
    const li=el('li',{}); li.dataset.key=it.key;
    if(it.image) li.appendChild(el('img',{src:it.image,className:'thumb'}));
    if(it.text) li.appendChild(el('div',{},it.text));
    if(it.audio) li.appendChild(miniAudio(it.audio,'Play'));
    if(it.video) li.appendChild(miniVideo(it.video));
    if(it.hint){ const hb=el('button',{className:'chip',type:'button'},'üí°'); const ht=el('span',{className:'muted',style:'display:none;margin-left:6px'},it.hint); hb.onclick=()=>{ ht.style.display=ht.style.display==='none'?'inline':'none'; }; li.append(hb,ht); }
    li.draggable=true; addDragHandlers(li,rightCol); rightCol.appendChild(li);
    if(settings.autoTTSItems && it.text) li.onclick=()=>speak(it.text);
  });

  grid.append(leftCol,rightCol); qc.appendChild(grid);
  const s=el('button',{className:'btn btn-primary'}, t('submit'));
  s.onclick=()=>{ const order=[...rightCol.children].map(li=>li.dataset.key); const ok=order.every((v,i)=> v===String(i)); proceed(ok,q); };
  qctrl.appendChild(s);
}

function renderPlayOrder(q, qc, qctrl){
  const items=(q.sequence||[]).map((t,i)=> typeof t==='object'? Object.assign({key:String(i)},t) : {text:String(t||''), key:String(i)});
  const sh=shuffle(items.slice());
  const list=el('ul',{className:'sort-list'});
  sh.forEach(it=>{ const li=el('li',{}); li.dataset.key=it.key; if(it.image) li.appendChild(el('img',{src:it.image,className:'thumb'})); if(it.text) li.appendChild(el('div',{},it.text)); if(it.audio) li.appendChild(miniAudio(it.audio,'Play')); if(it.video) li.appendChild(miniVideo(it.video)); if(it.hint){ const hb=el('button',{className:'chip',type:'button'},'üí°'); const ht=el('span',{className:'muted',style:'display:none;margin-left:6px'},it.hint); hb.onclick=()=>{ ht.style.display=ht.style.display==='none'?'inline':'none'; }; li.append(hb,ht); } li.draggable=true; addDragHandlers(li,list); list.appendChild(li); if(settings.autoTTSItems && it.text) li.onclick=()=>speak(it.text); });
  qc.appendChild(list);
  const s=el('button',{className:'btn btn-primary'}, t('submit')); s.onclick=()=>{ const order=[...list.children].map(li=>li.dataset.key); const ok=order.every((v,i)=> v===String(i)); proceed(ok,q); }; qctrl.appendChild(s);
}

function renderPlayMultiText(q, qc, qctrl){
  const inputs=[];
  const prompts=(q.prompts&&q.prompts.length?q.prompts:['Answer 1','Answer 2']).map(p=> typeof p==='string'? {text:p,hint:''}:p);
  let s;
  const check=()=> inputs.every((inp,idx)=> normalizeText(inp.value) === normalizeText(prompts[idx]?.text||''));
  let submitted=false;
  const submit=()=>{ if(submitted) return; submitted=true; inputs.forEach(i=>i.disabled=true); s.disabled=true; proceed(check(), q); };
  prompts.forEach((p,idx)=>{
    if(p.hint){
      const hb=el('button',{className:'chip',type:'button'},'üí°');
      const ht=el('span',{className:'muted',style:'display:none;margin-left:6px'},p.hint);
      hb.onclick=()=>{ ht.style.display=ht.style.display==='none'?'inline':'none'; };
      qc.append(hb,ht);
    }
    const inp=el('input',{type:'text',placeholder:`Answer ${idx+1}`});
    qc.appendChild(inp);
    inputs.push(inp);
    inp.addEventListener('keydown',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        e.stopPropagation();
        if(idx<inputs.length-1){
          inputs[idx+1].focus();
        } else {
          submit();
        }
      }
    });
  });
  if(inputs[0]) inputs[0].focus();
  s=el('button',{className:'btn btn-primary'}, t('submit'));
  s.onclick=submit;
  qctrl.appendChild(s);
}

function markSubmit(evalFn, qctrl, q){ const s=el('button',{className:'btn btn-primary'}, t('submit')); s.onclick=()=> proceed(!!evalFn(), q); qctrl.appendChild(s); }

// Drag helpers
function addDragHandlers(li, list){ li.addEventListener('dragstart',e=>{ li.classList.add('dragging-el'); e.dataTransfer.effectAllowed='move'; }); li.addEventListener('dragend',()=> li.classList.remove('dragging-el')); li.addEventListener('dragover',e=>{ e.preventDefault(); const dragging=list.querySelector('.dragging-el'); if(!dragging||dragging===li) return; const rect=li.getBoundingClientRect(); const after=(e.clientY-rect.top)>rect.height/2; list.insertBefore(dragging, after? li.nextSibling : li); }); }
// --- Overrides: editor with hint fields, collection, and text play ---
(function(){
  if(!window.el) return;
  const optHostRef = document.getElementById('questionOptionsContainer');
  const qTypeSelRef = document.getElementById('questionType');
  function buildAnswerRow(type, valueObj={}, idx, data){
    const row=el('div',{className:'row arow'});
    const correct=el('input',{type:type==='single'?'radio':'checkbox', name:'correct'});
    if(type==='single' && idx===(data.correct|0)) correct.checked=true;
    if(type==='multiple' && Array.isArray(data.corrects) && data.corrects.includes(idx)) correct.checked=true;
    const txt=el('input',{type:'text',placeholder:`Answer ${idx+1}`,value:valueObj.text||''});
    const hint=el('input',{type:'text',placeholder:'Hint (optional)',value:valueObj.hint||''});
    hint.dataset.role='hint';
    const iFile=el('input',{type:'file',accept:'image/*',style:'display:none'});
    const aFile=el('input',{type:'file',accept:'audio/*',style:'display:none'});
    const vFile=el('input',{type:'file',accept:'video/*',style:'display:none'});
    const iBtn=el('button',{className:'chip',type:'button'},'üñºÔ∏è'); iBtn.onclick=()=>iFile.click();
    const aBtn=el('button',{className:'chip',type:'button'},'üîà'); aBtn.onclick=()=>aFile.click();
    const vBtn=el('button',{className:'chip',type:'button'},'üìπ'); vBtn.onclick=()=>vFile.click();
    const preview=el('span',{});
    if(valueObj.image){ preview.appendChild(el('img',{src:valueObj.image,className:'thumb'})); row.dataset.img=valueObj.image; }
    if(valueObj.audio){ preview.appendChild(miniAudio(valueObj.audio,'Audio')); row.dataset.aud=valueObj.audio; }
    if(valueObj.video){ preview.appendChild(miniVideo(valueObj.video)); row.dataset.vid=valueObj.video; }
    iFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); row.dataset.img=d; const old=preview.querySelector('img'); if(old) old.remove(); preview.prepend(el('img',{src:d,className:'thumb'})); };
    aFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); row.dataset.aud=d; const old=preview.querySelector('.chip'); if(old) old.remove(); preview.appendChild(miniAudio(d,'Audio')); };
    vFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; const d=await fileToDataURL(f); row.dataset.vid=d; const old=preview.querySelector('video'); if(old) old.remove(); preview.appendChild(miniVideo(d)); };
    const del=el('button',{className:'btn btn-ghost',onclick:()=>row.remove()},'Remove');
    row.append(correct,txt,hint,iBtn,aBtn,vBtn,iFile,aFile,vFile,preview,del);
    return row;
  }
  function buildTextRow(obj){ const o=(typeof obj==='object'&&obj)?obj:{text:obj||'',hint:''}; const r=el('div',{className:'row'}); const i=el('input',{type:'text',value:o.text||'',placeholder:'Text'}); const h=el('input',{type:'text',value:o.hint||'',placeholder:'Hint (optional)'}); const d=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove'); r.append(i,h,d); return r; }
  function buildPairRow(p){ const r=el('div',{className:'row pair'});
    const leftWrap=el('div',{className:'row',style:'flex:1;align-items:flex-start'});
    const lLabel=el('label',{},'Left');
    const lText=el('input',{type:'text',value:(p.left?.text||p.left||''),placeholder:'Left text'});
    const lHint=el('input',{type:'text',value:(p.left?.hint||''),placeholder:'Left hint (optional)'});
    const leftRow=el('div',{className:'row'}); leftRow.dataset.img=p.left?.image||''; leftRow.dataset.aud=p.left?.audio||''; leftRow.dataset.vid=p.left?.video||'';
    mediaPickers(leftRow,{image:p.left?.image||'',audio:p.left?.audio||'',video:p.left?.video||''}).forEach(n=>leftRow.appendChild(n)); leftWrap.append(lLabel,lText,lHint,leftRow);
    const rightWrap=el('div',{className:'row',style:'flex:1;align-items:flex-start'});
    const rLabel=el('label',{},'Right');
    const rText=el('input',{type:'text',value:(p.right?.text||p.right||''),placeholder:'Right text'});
    const rHint=el('input',{type:'text',value:(p.right?.hint||''),placeholder:'Right hint (optional)'});
    const rightRow=el('div',{className:'row'}); rightRow.dataset.img=p.right?.image||''; rightRow.dataset.aud=p.right?.audio||''; rightRow.dataset.vid=p.right?.video||'';
    mediaPickers(rightRow,{image:p.right?.image||'',audio:p.right?.audio||'',video:p.right?.video||''}).forEach(n=>rightRow.appendChild(n)); rightWrap.append(rLabel,rText,rHint,rightRow);
    const del=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove'); r.append(leftWrap,rightWrap,del); return r; }
  function buildOrderRow(it){ const o=(typeof it==='object'&&it)?it:{text:String(it||''),image:'',audio:'',hint:'',video:''}; const r=el('div',{className:'row order-row'}); const iText=el('input',{type:'text',value:o.text||'',placeholder:'Item text'}); const iHint=el('input',{type:'text',value:o.hint||'',placeholder:'Hint (optional)'}); const mediaRow=el('div',{className:'row'}); mediaRow.dataset.img=o.image||''; mediaRow.dataset.aud=o.audio||''; mediaRow.dataset.vid=o.video||''; mediaPickers(mediaRow,{image:o.image||'',audio:o.audio||'',video:o.video||''}).forEach(n=>mediaRow.appendChild(n)); const d=el('button',{className:'btn btn-ghost',onclick:()=>r.remove()},'Remove'); r.append(iText,iHint,mediaRow,d); return r; }

  function renderOptionsEditor_v2(data={}){
    const optHost=optHostRef; if(!optHost||!qTypeSelRef) return; optHost.innerHTML='';
    const type=qTypeSelRef.value;
    if(type==='single' || type==='multiple'){
      const list=el('div',{id:'answersList'});
      const src = (data.answers&&data.answers.length? data.answers : [{text:''},{text:''},{text:''}]);
      src.forEach((ans,i)=> list.appendChild(buildAnswerRow(type, ans, i, data)) );
      const addBtn = el('button',{className:'btn',onclick:()=> list.appendChild(buildAnswerRow(type,{text:''}, list.querySelectorAll('.arow').length, data))}, '‚ûï Add answer');
      optHost.append(list, addBtn, el('div',{className:'muted'}, type==='single'?'Mark one correct.':'Mark all correct.'));
    }
    if(type==='text'){
      const list=el('div',{id:'txtAccept'});
      const src=(data.acceptable&&data.acceptable.length? data.acceptable : [{text:''}] );
      src.forEach(v=> list.appendChild(buildTextRow(v)) );
      const add=el('button',{className:'btn',onclick:()=> list.appendChild(buildTextRow({text:''}))}, '‚ûï Add acceptable');
      optHost.append(el('div',{className:'muted'},'Answers are compared using the Text Matching settings.'), list, add);
    }
    if(type==='multitext'){
      const list=el('div',{id:'multiPrompts'});
      (data.prompts&&data.prompts.length?data.prompts:[{text:'Answer 1'},{text:'Answer 2'}]).forEach(lbl=> list.appendChild(buildTextRow(lbl)));
      const add=el('button',{className:'btn',onclick:()=> list.appendChild(buildTextRow({text:''}))}, '‚ûï Add field');
      optHost.append(el('div',{className:'muted'},'Player must fill all fields.'), list, add);
    }
    if(type==='matching'){
      const wrap=el('div',{id:'pairsWrap'});
      (data.pairs&&data.pairs.length? data.pairs : [{left:{text:''},right:{text:''}}]).forEach(p=> wrap.appendChild(buildPairRow(p)));
      const add=el('button',{className:'btn',onclick:()=> wrap.appendChild(buildPairRow({left:{text:''},right:{text:''}}))}, '‚ûï Add pair');
      optHost.append(el('div',{className:'muted'},'In play, drag RIGHT to match LEFT. Each side can have text, image, audio, and an optional hint.'), wrap, add);
    }
    if(type==='order'){
      const list=el('div',{id:'orderList'});
      (data.sequence&&data.sequence.length? data.sequence : [{text:''},{text:''}]).forEach(it=> list.appendChild(buildOrderRow(it)) );
      const add=el('button',{className:'btn',onclick:()=> list.appendChild(buildOrderRow({text:''}))}, '‚ûï Add item');
      optHost.append(el('div',{className:'muted'},'The correct order is the editor order. Items can include text, image, audio, and an optional hint.'), list, add);
    }
  }
  window.renderOptionsEditor = renderOptionsEditor_v2;
  function convertQuestionData(prev, newType){
    const out={};
    if(newType==='text'){
      if(prev.type==='single'){
        const a=prev.answers?.[prev.correct]; if(a) out.acceptable=[{text:a.text||''}];
      } else if(prev.type==='multiple'){
        out.acceptable=(prev.corrects||[]).map(i=>({text:prev.answers?.[i]?.text||''}));
      } else if(prev.acceptable){
        out.acceptable=prev.acceptable;
      }
    }
    if(newType==='single' || newType==='multiple'){
      let answers=[];
      if(prev.answers) answers=prev.answers;
      else if(prev.acceptable) answers=prev.acceptable.map(a=>({text:a.text||a}));
      out.answers=answers.length?answers:[{text:''},{text:''}];
      if(newType==='single'){
        out.correct=(prev.type==='single' && typeof prev.correct==='number')?prev.correct:0;
      } else {
        if(prev.type==='multiple') out.corrects=prev.corrects||[]; else if(prev.type==='single') out.corrects=[prev.correct]; else out.corrects=[];
      }
    }
    return out;
  }
  if(qTypeSelRef){
    qTypeSelRef.dataset.prevType=qTypeSelRef.value;
    qTypeSelRef.onchange=()=>{
      const prevType=qTypeSelRef.dataset.prevType;
      let prev={type:prevType};
      try{ const cur=qTypeSelRef.value; qTypeSelRef.value=prevType; prev=window.collectQuestion(); qTypeSelRef.value=cur; }catch(e){}
      const newType=qTypeSelRef.value; qTypeSelRef.dataset.prevType=newType;
      window.renderOptionsEditor(convertQuestionData(prev,newType));
    };
  }
  if(optHostRef){ window.renderOptionsEditor(); }

  // Override collectQuestion to include hints
  window.collectQuestion = function(){
    const type=qTypeSelRef.value; const question=document.getElementById('questionText').value.trim();
    const q={type, question, questionMedia:{image:qImgData||'', audio:qAudData||'', video:qVidData||''}, comment:(document.getElementById('questionComment').value||'').trim(), commentMedia:{image:cImgData||'', audio:cAudData||'', video:cVidData||''}};
    const catSel=document.getElementById('categorySelect'); if(catSel && catSel.value) q.categoryId=catSel.value;
    if(type==='single' || type==='multiple'){
      const rows=[...optHostRef.querySelectorAll('#answersList .arow')];
      const answers=rows.map(r=>({
        text:r.querySelector('input[type="text"]').value.trim(),
        hint:(r.querySelector('input[placeholder="Hint (optional)"]')?.value||'').trim(),
        image:r.dataset.img||'', audio:r.dataset.aud||'', video:r.dataset.vid||''
      })).filter(a=>a.text||a.image||a.audio||a.video);
      if(type==='single'){ const idx=rows.findIndex(r=> r.querySelector('input[type="radio"]').checked); Object.assign(q,{answers,correct:idx}); }
      else { const corrects=rows.map((r,i)=> r.querySelector('input[type="checkbox"]').checked? i : -1).filter(i=>i!==-1); Object.assign(q,{answers,corrects}); }
    }
    if(type==='text'){
      q.acceptable=[...optHostRef.querySelectorAll('#txtAccept .row')].map(r=>({
        text:r.querySelector('input[placeholder="Text"]').value.trim(),
        hint:(r.querySelector('input[placeholder="Hint (optional)"]')?.value||'').trim()
      })).filter(o=>o.text);
    }
    if(type==='multitext'){
      q.prompts=[...optHostRef.querySelectorAll('#multiPrompts .row')].map(r=>({
        text:r.querySelector('input[placeholder="Text"]').value.trim(),
        hint:(r.querySelector('input[placeholder="Hint (optional)"]')?.value||'').trim()
      })).filter(o=>o.text);
    }
    if(type==='matching'){
      q.pairs=[...optHostRef.querySelectorAll('#pairsWrap .pair')].map(row=>{
        const leftWrap=row.children[0], rightWrap=row.children[1];
        const lText=leftWrap.querySelector('input[placeholder="Left text"]').value.trim();
        const lHint=(leftWrap.querySelector('input[placeholder="Left hint (optional)"]')?.value||'').trim();
        const lMedia=leftWrap.querySelector('.row');
        const rText=rightWrap.querySelector('input[placeholder="Right text"]').value.trim();
        const rHint=(rightWrap.querySelector('input[placeholder="Right hint (optional)"]')?.value||'').trim();
        const rMedia=rightWrap.querySelector('.row');
        return { left:{text:lText, hint:lHint, image:lMedia?.dataset?.img||'', audio:lMedia?.dataset?.aud||'', video:lMedia?.dataset?.vid||''}, right:{text:rText, hint:rHint, image:rMedia?.dataset?.img||'', audio:rMedia?.dataset?.aud||'', video:rMedia?.dataset?.vid||''} };
      }).filter(p=> (p.left.text||p.left.image||p.left.audio||p.left.video||p.right.text||p.right.image||p.right.audio||p.right.video));
    }
    if(type==='order'){
      q.sequence=[...optHostRef.querySelectorAll('#orderList .order-row')].map(r=>{
        const t=r.querySelector('input[placeholder="Item text"]').value.trim();
        const h=(r.querySelector('input[placeholder="Hint (optional)"]')?.value||'').trim();
        const m=r.querySelector('.row');
        return { text:t, hint:h, image:m?.dataset?.img||'', audio:m?.dataset?.aud||'', video:m?.dataset?.vid||'' };
      }).filter(it=> it.text||it.image||it.audio||it.video);
    }
    return q;
  };

  // Override renderPlayText to accept acceptable objects
  window.renderPlayText = function(q, qc, qctrl){
    const inp=el('input',{type:'text',placeholder:settings.lang==='de'?'Deine Antwort':'Your answer'});
    qc.appendChild(inp);
    inp.focus();
    const acceptable=(q.acceptable||[]).map(a=> typeof a==='string'? {text:a} : a);
    const hintAll=acceptable.map(a=>a.hint).filter(Boolean).join(' ¬∑ ');
    if(hintAll){ const hBtn=el('button',{className:'chip',type:'button'},'üí°'); const hTxt=el('span',{className:'muted',style:'display:none;margin-left:6px'},hintAll); hBtn.onclick=()=>{ hTxt.style.display=hTxt.style.display==='none'?'inline':'none'; }; qc.append(hBtn,hTxt); }
    const check=()=>{
      const u=normalizeText(inp.value);
      if(acceptable.some(a=> normalizeText(a.text)===u)) return {ok:true};
      if(acceptable.length>=2){
        const exact=parseInt(acceptable[0].text,10);
        const m=acceptable[1].text.match(/^\[(\d+),(\d+)\]$/);
        const val=parseInt(inp.value,10);
        if(Number.isInteger(exact) && m && Number.isInteger(val)){
          const a=parseInt(m[1],10), b=parseInt(m[2],10);
          if(val>=a && val<=b && val!==exact) return {ok:true, goodGuess:true};
        }
      }
      return {ok:false};
    };
    const s=el('button',{className:'btn btn-primary'}, t('submit'));
    let submitted=false;
    const submit=()=>{
      if(submitted) return;
      submitted=true;
      inp.disabled=true;
      s.disabled=true;
      const r=check();
      if(r.goodGuess) proceed(true,q,t('goodguess'),{showCorrect:true}); else proceed(r.ok,q);
    };
    s.onclick=submit;
    qctrl.appendChild(s);
    inp.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); submit(); } });
  };
})();
</script>
</body>
</html>
